/*
 * jQuery Stream 1.1.1
 * Comet Streaming JavaScript Library 
 * http://code.google.com/p/jquery-stream/
 * 
 * Copyright 2011, Donghwan Kim 
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Compatible with jQuery 1.4+
 */
(function(c){function g(a,b){this.url=a;this.options=c.extend(!0,{},this.options,b);for(var f in{open:1,message:1,error:1,close:1})this.options[f]=c.makeArray(this.options[f]);e[this.url]=this;this.options.alias&&(e[this.options.alias]=this);f=/^(http|ws)s?:/.exec(this.url);this.options.type=f&&f[1]||this.options.type;c.extend(!0,this,k[this.options.type]);if(this.options.type==="ws"||!i)this.open();else{var d=this;switch(this.options.throbber.type||this.options.throbber){case "lazy":c(window).load(function(){setTimeout(function(){d.open()},
d.options.throbber.delay||50)});break;case "reconnect":d.open(),c(window).load(function(){function a(){d.options.close.push(function(){d.options.close.pop();setTimeout(function(){new g(d.url,d.options)},d.options.throbber.delay||50)});var b=d.options.reconnect;d.close();d.options.reconnect=b}d.readyState===0?d.options.open.push(function(){d.options.open.pop();setTimeout(function(){a()},10)}):a()})}}}function j(a,b){(function d(){setTimeout(function(){b.call(a)!==!1&&d()},0)})()}function h(a,b){var f=
/([?&]_=)[^&]*/;b&&typeof b!=="string"&&(b=c.param(b));return(f.test(a)?a:a+(/\?/.test(a)?"&":"?")+"_=").replace(f,"$1"+(new Date).getTime())+(b?"&"+b:"")}function l(a,b){var b=c.extend({},b,{type:a}),f={},d;for(d in b)f["metadata."+d]=b[d];return c.param(f)}var e={},k={},m={},i=c.browser.webkit&&!c.isReady;c.extend(g.prototype,{readyState:0,options:{type:window.WebSocket?"ws":"http",reconnect:!0,global:!0,throbber:"lazy",dataType:"text",converters:{text:window.String,json:c.parseJSON,xml:c.parseXML}},
trigger:function(a,b){for(var a=a.type?a:c.extend(c.Event(a),{bubbles:!1,cancelable:!1},b),f=this.options[a.type],d=[a,this],e=0;e<f.length;e++)f[e].apply(this.options.context,d);this.options.global&&c.event.trigger("stream"+a.type.substring(0,1).toUpperCase()+a.type.substring(1),d)}});i&&c(window).load(function(){i=!1});c.extend(k,{ws:{open:function(){if(window.WebSocket){var a=this,b=h(function(a){var b=document.createElement("div");b.innerHTML="<a href='"+a+"'/>";return b.firstChild.href}(this.url).replace(/^http/,
"ws"),this.options.openData);this.ws=this.options.protocols?new window.WebSocket(b,this.options.protocols):new window.WebSocket(b);c.extend(this.ws,{onopen:function(b){a.readyState=1;a.trigger(b)},onmessage:function(b){a.trigger(c.extend({},b,{data:a.options.converters[a.options.dataType](b.data)}))},onerror:function(b){a.options.reconnect=!1;a.trigger(b)},onclose:function(b){var c=a.readyState;a.readyState=3;a.trigger(b);a.options.reconnect&&c!==0&&new g(a.url,a.options)}})}},send:function(a){this.readyState===
0&&c.error("INVALID_STATE_ERR: Stream not open");this.ws.send(typeof a==="string"?a:c.param(a,c.ajaxSettings.traditional))},close:function(){if(this.readyState<2)this.readyState=2,this.options.reconnect=!1,this.ws.close()}},http:{open:function(){var a=this.options.enableXDR&&window.XDomainRequest?"xdr":window.ActiveXObject?"iframe":window.XMLHttpRequest?"xhr":null;a&&c.extend(!0,this,m[a]).connect()},send:function(a){this.readyState===0&&c.error("INVALID_STATE_ERR: Stream not open");arguments.length&&
this.dataQueue.push((typeof a==="string"?a:c.param(a,c.ajaxSettings.traditional))+"&");if(this.sending!==!0)this.sending=!0,function f(){this.readyState===1&&this.dataQueue.length?c.ajax({url:this.url,context:this,type:"POST",data:this.dataQueue.shift()+l("send",{id:this.id}),complete:f}):this.sending=!1}.call(this)},close:function(){if(this.readyState<2)this.readyState=2,c.post(this.url,l("close",{id:this.id})),this.options.reconnect=!1,this.disconnect()},handleResponse:function(a){if(this.readyState===
0)this.id=a.substring(0,a.indexOf(";")),this.message={index:a.indexOf(";",this.id.length+1)+1,size:null,data:""},this.dataQueue=this.dataQueue||[],this.readyState=1,this.trigger("open"),this.send();for(;;){if(this.message.size==null){var b=a.indexOf(";",this.message.index);if(b<0)break;this.message.size=+a.substring(this.message.index,b);this.message.index=b+1}b=a.substr(this.message.index,this.message.size-this.message.data.length);this.message.data+=b;this.message.index+=b.length;if(this.message.size!==
this.message.data.length)break;b=a.indexOf(";",this.message.index);if(b<0)break;this.message.index=b+1;this.message.data=this.options.converters[this.options.dataType](this.message.data);this.readyState<3&&this.trigger("message",{data:this.message.data,origin:"",lastEventId:"",source:null,ports:null});this.message.size=null;this.message.data=""}},handleClose:function(a){var b=this.readyState;this.readyState=3;if(a)switch(this.options.reconnect=!1,b){case 0:this.trigger("close",{wasClean:!1,code:null,
reason:""});break;case 1:case 2:this.trigger("error")}else this.trigger("close",{wasClean:!0,code:null,reason:""}),this.options.reconnect&&new g(this.url,this.options)}}});c.extend(m,{xhr:{connect:function(){var a=this;this.xhr=new window.XMLHttpRequest;this.xhr.onreadystatechange=function(){switch(this.readyState){case 3:if(this.status!==200)break;a.handleResponse(this.responseText);if(c.browser.opera&&!this.polling)this.polling=!0,j(this,function(){if(this.readyState===4)return!1;this.responseText.length>
a.message.index&&a.handleResponse(this.responseText)});break;case 4:a.handleClose(this.status!==200&&this.preStatus!==200)}};this.xhr.open("GET",h(this.url,this.options.openData));this.xhr.send()},disconnect:function(){try{this.xhr.preStatus=this.xhr.status}catch(a){}this.xhr.abort()}},iframe:{connect:function(){this.doc=new window.ActiveXObject("htmlfile");this.doc.open();this.doc.close();var a=this.doc.createElement("iframe");a.src=h(this.url,this.options.openData);this.doc.body.appendChild(a);
var b=a.contentDocument||a.contentWindow.document;j(this,function(){if(b.documentElement){if(b.readyState==="complete")try{c.noop(b.fileSize)}catch(a){return this.handleClose(!0),!1}var d=b.body.firstChild;this.handleResponse(d.innerText);j(this,function(){var a=d.innerText;if(a.length>this.message.index)this.handleResponse(a),d.innerText="",this.message.index=0;if(b.readyState==="complete")return this.handleClose(),!1});return!1}})},disconnect:function(){this.doc.execCommand("Stop")}},xdr:{connect:function(){function a(a){var b=
{JSESSIONID:function(b){return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b+"$1")},PHPSESSID:function(b){return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b+"&").replace(/&$/,"")}},c;for(c in b){var e=RegExp("(?:^|;\\s*)"+encodeURIComponent(c)+"=([^;]*)").exec(document.cookie);if(e)return b[c](e[1])}return a}var b=this;this.xdr=new window.XDomainRequest;this.xdr.onprogress=function(){b.handleResponse(this.responseText)};this.xdr.onerror=function(){b.handleClose(!0)};this.xdr.onload=
function(){b.handleClose()};this.xdr.open("GET",h((this.options.rewriteURL||a)(this.url),this.options.openData));this.xdr.send()},disconnect:function(){var a=this.xdr.onload;this.xdr.abort();a()}}});c(window).bind("unload.stream",function(){c.each(e,function(a){this.close();delete e[a]})});c.stream=function(a,b){switch(arguments.length){case 0:for(var c in e)return e[c];return null;case 1:return e[a]||null;default:return e[a]&&e[a].readyState!==3?e[a]:new g(a,b)}};c.extend(c.stream,{version:"1.1.1",
options:g.prototype.options,setup:function(a){return c.extend(!0,g.prototype.options,a)}});c.each("streamOpen streamMessage streamError streamClose".split(" "),function(a,b){c.fn[b]=function(a){return this.bind(b,a)}})})(jQuery);